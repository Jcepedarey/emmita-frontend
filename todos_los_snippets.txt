========================================
SNIPPET: Resumen de stock y pedidos abiertos
ID: dcbc3aa0-e7d7-4f5b-9071-c8daaec3ae83
FECHA: 2025-12-04T20:41:29.967161+00:00
========================================

-- 1. Stock base
SELECT stock FROM productos WHERE nombre ILIKE '%silla tiffany%';

-- 2. Total pedidos abiertos
SELECT COUNT(*) FROM ordenes_pedido WHERE cerrada = false;

-- 3. Total sillas en pedidos del 06/12
SELECT SUM(CAST(p->>'cantidad' AS INTEGER))
FROM ordenes_pedido, jsonb_array_elements(productos) AS p
WHERE cerrada = false
  AND fecha_evento = '2025-12-06'
  AND p->>'nombre' ILIKE '%silla tiffany%';


========================================
SNIPPET: Product stock lookup
ID: c29027fa-b2f0-48fd-bacb-1747f79e91f8
FECHA: 2025-12-04T18:58:49.814274+00:00
========================================

SELECT stock FROM productos WHERE nombre ILIKE '%silla tiffany%';


========================================
SNIPPET: Detectar n├║meros de pedido duplicados
ID: 53a7f995-e78e-4ee3-8a63-a16cd96dab92
FECHA: 2025-12-04T18:35:32.807145+00:00
========================================

-- Debe retornar 0 filas
SELECT numero, COUNT(*)
FROM ordenes_pedido
GROUP BY numero
HAVING COUNT(*) > 1;


========================================
SNIPPET: Pedidos con n├║mero duplicado
ID: 6b281fe7-b3f6-474e-8019-906fc42ec088
FECHA: 2025-12-04T18:32:39.852398+00:00
========================================

-- Crear ├¡ndice ├║nico en el n├║mero de pedido
CREATE UNIQUE INDEX IF NOT EXISTS idx_ordenes_pedido_numero_unique 
ON ordenes_pedido(numero);


========================================
SNIPPET: Sillas Tiffany reservadas el 06/12/2025
ID: 9ce56ec5-d94a-47cc-90a0-29c748d5ddd9
FECHA: 2025-12-04T18:12:30.857675+00:00
========================================

-- Ver pedidos con el mismo n├║mero pero diferentes fechas o IDs
SELECT 
  numero,
  COUNT(*) as veces_aparece,
  array_agg(DISTINCT fecha_evento) as fechas_diferentes,
  array_agg(DISTINCT id) as ids_diferentes,
  array_agg(DISTINCT cerrada) as estados
FROM ordenes_pedido
GROUP BY numero
HAVING COUNT(*) > 1
ORDER BY veces_aparece DESC;


========================================
SNIPPET: Open orders with 'silla tiffany'
ID: 187efdfb-522f-4403-aa58-860f1971c323
FECHA: 2025-12-04T18:07:19.059922+00:00
========================================

SELECT 
  numero,
  fecha_evento,
  fechas_evento,
  multi_dias,
  cerrada,
  jsonb_array_length(productos) as total_items,
  productos
FROM ordenes_pedido
WHERE cerrada = false
  AND productos::text ILIKE '%silla tiffany%'
ORDER BY fecha_evento;


========================================
SNIPPET: Productos: buscar 'Silla Tiffany'
ID: 67771b3c-f17e-49e0-9d10-759d5c680f7b
FECHA: 2025-12-04T18:05:57.640545+00:00
========================================

SELECT id, nombre, stock 
FROM productos 
WHERE nombre ILIKE '%silla tiffany%';


========================================
SNIPPET: Reservas de Silla Rimax en pedidos abiertos
ID: 574af0f8-aec0-46c8-8c08-d1d22898ec17
FECHA: 2025-12-04T04:59:28.221814+00:00
========================================

-- Contar TODAS las reservas de "Silla rimax" en pedidos abiertos
WITH reservas AS (
  SELECT 
    numero,
    fecha_evento,
    fechas_evento,
    multi_dias,
    p->>'nombre' as nombre_producto,
    CAST(p->>'cantidad' AS INTEGER) as cantidad,
    CASE 
      WHEN p->>'es_grupo' = 'true' THEN 'grupo'
      ELSE 'producto'
    END as tipo
  FROM ordenes_pedido,
  jsonb_array_elements(productos) AS p
  WHERE cerrada = false
    AND (
      p->>'nombre' ILIKE '%silla rimax%'
      OR EXISTS (
        SELECT 1 FROM jsonb_array_elements(p->'productos') AS sub
        WHERE sub->>'nombre' ILIKE '%silla rimax%'
      )
    )
)
SELECT 
  COUNT(*) as pedidos_con_sillas,
  SUM(cantidad) as total_sillas_reservadas,
  array_agg(DISTINCT numero) as numeros_pedido
FROM reservas;


========================================
SNIPPET: Stale Open Orders (>30 days)
ID: f026002d-68d5-4b70-a6c3-955b8809c5f5
FECHA: 2025-12-04T04:50:26.285796+00:00
========================================

-- Pedidos que deber├¡an estar cerrados pero no lo est├ín (CORREGIDO)
SELECT 
  numero,
  fecha_evento,
  fechas_evento,
  multi_dias,
  cerrada,
  revisada,
  fecha_creacion,
  jsonb_array_length(productos) as total_items
FROM ordenes_pedido
WHERE cerrada = false
  AND fecha_evento < CURRENT_DATE - INTERVAL '30 days'
ORDER BY fecha_evento ASC;


========================================
SNIPPET: Detecci├│n de pedidos duplicados abiertos
ID: 6620de1f-b9a8-48fb-bd17-f6290c15a847
FECHA: 2025-12-04T04:47:48.758508+00:00
========================================

-- Detectar posibles duplicados
SELECT 
  cliente_id,
  fecha_evento,
  total,
  COUNT(*) as veces_duplicado,
  array_agg(numero) as numeros_pedido
FROM ordenes_pedido
WHERE cerrada = false
GROUP BY cliente_id, fecha_evento, total
HAVING COUNT(*) > 1
ORDER BY veces_duplicado DESC;


